{% extends "base.html" %}{% block content %}
<div class="container mt-5">
  <h2 class="mb-4 text-primary">Add a LEGO Set To Your Collection</h2>
  <form
    id="addSetForm"
    action="/addset"
    method="post"
    enctype="multipart/form-data"
  >
    <div class="mb-3">
      <label for="setSearch" class="form-label text-secondary"
        >Search Sets (by ID or Name)</label
      >
      <input
        type="text"
        class="form-control"
        id="setSearch"
        placeholder="Start typing to search sets..."
        autocomplete="off"
      />
      <div
        id="suggestions"
        class="mt-2"
        style="
          display: none;
          max-height: 300px;
          overflow-y: auto;
          border: 1px solid #ddd;
          border-radius: 0.375rem;
        "
      ></div>
    </div>
    <input type="hidden" id="selectedSet" name="set_num" />
    <div class="mb-3" id="imageUploadDiv" style="display: none">
      <label for="image" class="form-label">Upload Image</label>
      <input
        type="file"
        class="form-control"
        id="image"
        name="image"
        accept="image/*"
      />
    </div>
    <button type="submit" class="btn btn-lego-blue" id="submitBtn" disabled>
      Submit Set
    </button>
  </form>
</div>
{% endblock %} {% block scripts %}
<script>
  let sets = [];

  fetch("{{ url_for('static', filename='sets.csv') }}")
    .then((response) => response.text())
    .then((data) => {
      const lines = data.split("\n");
      lines.slice(1).forEach((line) => {
        if (line.trim()) {
          const fields = line.split(",");
          const set_num = fields[0].replace(/^"|"$/g, "");
          const name = fields[1].replace(/^"|"$/g, "");
          const year = fields[2].replace(/^"|"$/g, "");
          const theme_id = fields[3].replace(/^"|"$/g, "");
          const num_parts = fields[4].replace(/^"|"$/g, "");
          const img_url = fields[5].replace(/^"|"$/g, "");
          if (set_num && name) {
            sets.push({
              set_num,
              name,
              year,
              theme_id,
              num_parts,
              img_url,
            });
          }
        }
      });
    });

  document.getElementById("setSearch").addEventListener("input", function () {
    const query = this.value.toLowerCase().trim();
    const suggestionsDiv = document.getElementById("suggestions");
    if (query.length < 2) {
      suggestionsDiv.style.display = "none";
      return;
    }
    const filtered = sets
      .filter(
        (set) =>
          set.set_num.toLowerCase().includes(query) ||
          set.name.toLowerCase().includes(query)
      )
      .slice(0, 5);
    suggestionsDiv.innerHTML = "";
    if (filtered.length > 0) {
      filtered.forEach((set) => {
        const item = document.createElement("div");
        item.className = "d-flex align-items-center p-2 border-bottom bg-light";
        item.style.cursor = "pointer";
        item.innerHTML = `<img src="${set.img_url}" alt="${set.name}" class="me-3" style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px;">
              <div>
                <strong>${set.name}</strong><br>
                <small class="text-muted">ID: ${set.set_num} | Year: ${set.year} | Parts: ${set.num_parts}</small>
              </div>`;
        item.addEventListener("click", () => selectSet(set));
        suggestionsDiv.appendChild(item);
      });
      suggestionsDiv.style.display = "block";
    } else {
      suggestionsDiv.style.display = "none";
    }
  });

  function selectSet(set) {
    document.getElementById(
      "setSearch"
    ).value = `${set.name} (ID: ${set.set_num})`;
    document.getElementById("selectedSet").value = set.set_num;
    document.getElementById("suggestions").style.display = "none";
    document.getElementById("imageUploadDiv").style.display = "block";
  }

  document.getElementById("image").addEventListener("change", function (event) {
    document.getElementById("submitBtn").disabled = false;
  });

  document.addEventListener("click", function (event) {
    const searchInput = document.getElementById("setSearch");
    const suggestionsDiv = document.getElementById("suggestions");
    if (
      !searchInput.contains(event.target) &&
      !suggestionsDiv.contains(event.target)
    ) {
      suggestionsDiv.style.display = "none";
    }
  });
</script>
{% endblock %}
